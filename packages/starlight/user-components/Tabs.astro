---
import { processPanels } from './rehype-tabs';

const panelHtml = await Astro.slots.render('default');
const { html, panels } = processPanels(panelHtml);
---

<starlight-tabs class="not-prose border border-zinc-400/40 rounded-xl flex flex-col justify-center">
	{
		panels && (
			<div class="p-4">
				<ul class="flex space-x-2" role="tablist">
					{panels.map(({ label, panelId, tabId }, idx) => (
						<li role="presentation">
							<a
								class="px-4 py-2 rounded-md"
								role="tab"
								href={'#' + panelId}
								id={tabId}
								aria-selected={idx === 0 && 'true'}
								tabindex={idx !== 0 ? -1 : 0}
							>
								{label}
							</a>
						</li>
					))}
				</ul>
			</div>
		)
	}
	<div class="h-[1px] w-full bg-zinc-400/40"></div>
	<Fragment set:html={html} />
</starlight-tabs>

<style>
	[aria-selected='true'] {
		@apply dark:bg-white dark:text-black text-white bg-black;
	}

	:root {
		--astro-code-color-text: #ffffff;
		--astro-code-token-constant: #3b82f6;
		--astro-code-token-string: #ec4899;
		--astro-code-token-comment: #e4e4e7;
		--astro-code-token-keyword: var(--sl-color-purple-high);
		--astro-code-token-parameter: #8b5cf6;
		--astro-code-token-function: #8b5cf6;
		--astro-code-token-string-expression: var(--sl-color-green-high);
		--astro-code-token-punctuation: var(--sl-color-gray-2);
		--astro-code-token-link: var(--sl-color-blue-high);
	}
</style>

<script>
	class StarlightTabs extends HTMLElement {
		tabs: HTMLAnchorElement[];
		panels: HTMLElement[];

		constructor() {
			super();
			const tablist = this.querySelector<HTMLUListElement>('[role="tablist"]')!;
			this.tabs = [...tablist.querySelectorAll<HTMLAnchorElement>('[role="tab"]')];
			this.panels = [...this.querySelectorAll<HTMLElement>(':scope > [role="tabpanel"]')];

			this.tabs.forEach((tab, i) => {
				// Handle clicks for mouse users
				tab.addEventListener('click', (e) => {
					e.preventDefault();
					const currentTab = tablist.querySelector('[aria-selected]');
					if (e.currentTarget !== currentTab) {
						this.switchTab(e.currentTarget as HTMLAnchorElement, i);
					}
				});

				// Handle keyboard input
				tab.addEventListener('keydown', (e) => {
					const index = this.tabs.indexOf(e.currentTarget as any);
					// Work out which key the user is pressing and
					// Calculate the new tab's index where appropriate
					const nextIndex =
						e.key === 'ArrowLeft'
							? index - 1
							: e.key === 'ArrowRight'
							? index + 1
							: e.key === 'Home'
							? 0
							: e.key === 'End'
							? this.tabs.length - 1
							: null;
					if (nextIndex === null) return;
					if (this.tabs[nextIndex]) {
						e.preventDefault();
						this.switchTab(this.tabs[nextIndex], nextIndex);
					}
				});
			});
		}

		switchTab(newTab: HTMLAnchorElement | null | undefined, index: number) {
			if (!newTab) return;

			// Mark all tabs as unselected and hide all tab panels.
			this.tabs.forEach((tab) => {
				tab.removeAttribute('aria-selected');
				tab.setAttribute('tabindex', '-1');
			});
			this.panels.forEach((oldPanel) => {
				oldPanel.hidden = true;
			});

			// Show new panel and mark new tab as selected.
			const newPanel = this.panels[index];
			if (newPanel) newPanel.hidden = false;
			// Restore active tab to the default tab order.
			newTab.removeAttribute('tabindex');
			newTab.setAttribute('aria-selected', 'true');
			newTab.focus();
		}
	}

	customElements.define('starlight-tabs', StarlightTabs);
</script>
